#!/usr/bin/env bash
#
# Content Cat - One command to run everything
#

set -e

INSTALL_DIR="$HOME/content-cat"

# Colors
CYAN='\033[0;36m'
GREEN='\033[0;32m'
YELLOW='\033[1;33m'
DIM='\033[2m'
NC='\033[0m'

# Check installation
if [[ ! -d "$INSTALL_DIR" ]]; then
    echo -e "${YELLOW}Content Cat not installed. Installing...${NC}"
    curl -fsSL https://raw.githubusercontent.com/KenKaiii/content-cat/main/scripts/install.sh | bash
    exit 0
fi

cd "$INSTALL_DIR"

echo ""
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo -e "${CYAN}  Content Cat${NC} ðŸ±"
echo -e "${CYAN}â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”â”${NC}"
echo ""

# Start Docker services if not running
if command -v docker &>/dev/null; then
    if ! docker ps &>/dev/null; then
        echo -e "${YELLOW}Starting Docker...${NC}"
        if [[ "$OSTYPE" == "darwin"* ]]; then
            open -a Docker
            echo -e "${DIM}Waiting for Docker to start...${NC}"
            while ! docker ps &>/dev/null; do sleep 1; done
        fi
    fi

    # Start database services
    if ! docker ps --format '{{.Names}}' | grep -q "content-cat-db"; then
        echo -e "${GREEN}â–¶${NC} Starting PostgreSQL and Redis..."
        docker compose up -d postgres redis
        sleep 2
    else
        echo -e "${GREEN}âœ“${NC} Database services running"
    fi
else
    echo -e "${YELLOW}âš ${NC} Docker not found - using local PostgreSQL"
fi

# Start the app
echo -e "${GREEN}â–¶${NC} Starting Content Cat..."
echo ""
echo -e "${DIM}  Press Ctrl+C to stop${NC}"
echo ""

pnpm dev
